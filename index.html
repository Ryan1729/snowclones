<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#888;
background-color:#111;
padding:0 10px
}
</style></head>
<body>
    <select id="snowclone-select">
        <option value="oh-my">Noun and Noun and Noun, oh my!</option>
    </select>
    <button id="get-snowclone">Randomly Fill Snowclone</button>
    <p id="output-snowclone"></p>
</body>
<script>

const button = document.getElementById("get-snowclone");
// Setting this on the tag means it isn't reset on refresh.
button.disabled = true

const output = (s) => {
    document.getElementById("output-snowclone").innerHTML = String(s)
}

const setup = (table) => {
    // Length of the file format's magic number.
    const MAGIC_LENGTH = 4;
    // ASCII 'l'
    const L_BYTE = 0x6C;
    if (
        table.length < MAGIC_LENGTH
        || table[0] != L_BYTE
        || table[1] != L_BYTE
        || table[2] != L_BYTE
    ) {
        output("Table was not .lll format");
        return
    }

    if (table[3] != 0) {
        output("Table was an unsupported version of .lll format:" + table[3]);
        return
    }

    const BLOCK_HEADER_LENGTH = 4;

    const SINGULAR_NOUN = 0b1;
    const PLURAL_NOUN   = 0b10;

    const decoder = new TextDecoder('utf8')

    const singluarNouns = [];
    const pluralNouns = [];

    let i = MAGIC_LENGTH;
    while (i < table.length) {
        const len = table[i] & 0x7F;
        if (len < BLOCK_HEADER_LENGTH) {
            output("Table seems corrupted: Block length was invalid: " + len);
            return
        }

        const blockEnd = i + len;
        if (blockEnd > table.length) {
            break
        }

        const fef = (table[i] & 0x80) == 0x80;

        if (fef) {
            // Skip because we don't know what the FEF does yet.
            i = blockEnd
            continue
        }

        const lexeme = decoder.decode(
            table.slice(
                i + BLOCK_HEADER_LENGTH,
                blockEnd
            )
        );

        // first flag byte
        const flags1 = table[i + 1];

        if (flags1 & SINGULAR_NOUN) {
            singluarNouns.push(lexeme)
        }

        if (flags1 & PLURAL_NOUN) {
            pluralNouns.push(lexeme)
        }

        // Skip reading last two flag bytes for now

        i = blockEnd
    }

    const nouns = singluarNouns.concat(pluralNouns)

    if (nouns.length <= 0) {
        output("Table contained no nouns");
        return
    }

    const rollNoun = () => {
        var i = Math.floor(Math.random() * nouns.length);

        return nouns[i];
    };

    const capitalizeFirst = (s) => (
        s.charAt(0).toUpperCase() + s.slice(1)
    );

    button.onclick = () => {
        output(`
${capitalizeFirst(rollNoun())} and ${rollNoun()} and ${rollNoun()}, oh my!
`);
    };

    button.disabled = false
}

try {
    fetch("db.lll")
        .then((response) => response.blob())
        .then((blob) => blob.arrayBuffer())
        .then((ab) => {
            setup(new Uint8Array(ab));
        })
        .catch(output)
} catch (e) {
    output(e);
}

</script>
</html>
